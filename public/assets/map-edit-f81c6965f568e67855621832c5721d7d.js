function initialize(){markers=new Array,recvResults=new Array,mapDiv=document.getElementById("map_canvas"),centerLatLng=new google.maps.LatLng(centerLatitude,centerLangitude),directionsDisplay=new google.maps.DirectionsRenderer,directionsService=new google.maps.DirectionsService;var e={center:centerLatLng,zoom:startZoom,mapTypeId:google.maps.MapTypeId.ROADMAP};currentMap=new google.maps.Map(mapDiv,e),directionsDisplay.setMap(currentMap),directionsDisplay.setPanel(document.getElementById("result-routes")),setAllMarkers(currentMap,getCurrentMapID()),showMap(),google.maps.event.addListener(currentMap,"click",function(e){createMarker(currentMap,e.latLng,"\u6211\u7684\u6807\u7b7e")})}function searchPlace(){var e=$("#address").val();return""==e?(alert("\u8bf7\u8f93\u5165\u8981\u5b9a\u4f4d\u7684\u5730\u540d\uff01"),!1):(geocoder=new google.maps.Geocoder,void(geocoder&&geocoder.geocode({address:e},function(e,t){t==google.maps.GeocoderStatus.OK?(recvResults=e,createPanels(recvResults),focusMarker(0)):alert("\u8c37\u6b4c\u5730\u56fe\u6ca1\u6709\u627e\u5230\u7684\u539f\u56e0\u662f:"+t)})))}function searchNavigation(){var e=document.getElementById("origin").value,t=document.getElementById("destination").value;alert(e+"-->"+t);var a={origin:e,destination:t,travelMode:google.maps.TravelMode.TRANSIT,provideRouteAlternatives:!0};directionsService.route(a,function(e,t){t==google.maps.DirectionsStatus.OK?directionsDisplay.setDirections(e):alert(t)})}function createPanels(e){alert(e.length);var t=$("#result-places");t.empty();for(var a=0;a<e.length;a++)createPanel(e[a],a)}function createPanel(e,t){alert(i);var a=e.address_components[t].short_name,r=e.formatted_address,n=$("#result-places"),o='<div id="panel_'+t+'" class="panel panel-primary map\u2014\u2014theme" onclick="focusMarker('+t+')"><div class="panel-heading"><h3 class="panel-title" id="title_'+t+'">'+a+'</h3></div><div class="panel-body"><div id="info_'+t+'">'+r+"</div></div></div>";n.append(o)}function toggleBounce(e){e.setAnimation(null!=e.getAnimation()?null:google.maps.Animation.BOUNCE)}function focusMarker(e){currentMap.setCenter(recvResults[e].geometry.location),createMarker(currentMap,recvResults[e].geometry.location,recvResults[e].address_components[e].short_name)}function distPrepare(){var e=$("#dist-button");e.empty();var t="<input type='button' class='btn btn-primary' id='cancel-dist' onclick='cancelDist();' value='\u9000\u51fa\u6d4b\u8ddd' class='inputBtn' /><input type='button' class='btn btn-danger' id='del-route' onclick='deleteOverlays();' value='\u6e05\u9664\u6807\u8bb0' class='inputBtn' /><br>\u4f30\u8ba1\u8ddd\u79bb\uff1a<span id='sum-distance'></span><br>\u4f30\u8ba1\u7528\u65f6\uff1a<span id='sum-duration'></span><br><div id='result-calculate'></div>";e.append(t),getDistance()}function cancelDist(){var e=$("#dist-button");e.empty();var t="<input type='button' class='btn btn-info' id='cal-dist' onclick='distPrepare();' value='\u6d4b\u8ddd' class='inputBtn' /><br>";e.append(t),deleteOverlays(),google.maps.event.clearListeners(currentMap,"click"),google.maps.event.addListener(currentMap,"click",function(e){createMarker(currentMap,e.latLng,"\u6211\u7684\u6807\u7b7e")})}function getDistance(){google.maps.event.clearListeners(currentMap,"click"),google.maps.event.addListener(currentMap,"click",function(e){addDistMarker(e.latLng)})}function addDistMarker(e){var t="http://labs.google.com/ridefinder/images/mm_20_red.png",a={position:e,draggable:!0,map:currentMap,icon:t};if(marker=new google.maps.Marker(a),0==lenArray.length){var t="http://www.google.com/mapfiles/dd-start.png";marker.setIcon(t),origin=e}else lenArray.length>=2;google.maps.event.addListener(marker,"dragend",function(){drawOverlay()}),lenArray.push(marker),drawOverlay()}function drawOverlay(){var e=[];if(lenArray)for(i in lenArray)e.push(lenArray[i].getPosition());var t={path:e,map:currentMap,strokeColor:"#FF0000",strokeOpacity:1,strokeWeight:2};if(polyline=new google.maps.Polyline(t),polylinesArray){for(i in polylinesArray)polylinesArray[i].setMap(null);polylinesArray=[]}polyline.setMap(currentMap),polylinesArray.push(polyline);var a=new google.maps.DistanceMatrixService;a.getDistanceMatrix({origins:e,destinations:e,travelMode:google.maps.TravelMode.DRIVING,avoidHighways:!1,avoidTolls:!1},callback)}function deleteOverlays(){if(lenArray){for(i in lenArray)lenArray[i].setMap(null);lenArray.length=0}if(polylinesArray){for(i in polylinesArray)polylinesArray[i].setMap(null);polylinesArray=[]}var e=$("#result-calculate");e.empty(),$("#sum-distance").text(""),$("#sum-duration").text("")}function callback(e,t){if(t==google.maps.DistanceMatrixStatus.OK){var a=e.originAddresses,r=e.destinationAddresses,n=a.length-1,i=$("#result-calculate");i.empty();for(var o=0,s=0,l=0;n>l;l++){var c=e.rows[l].elements,d=l+1,p=c[d],u=p.distance.value,g=p.duration.value,m=a[l],v=r[d];o+=u,s+=g;var f='<div id="panel_'+d+'" class="panel panel-primary" onclick="focusMarker('+d+')"><div class="panel-heading"><h3 class="panel-title" id="title_'+d+'">\u5b50\u8def\u7ebf'+d+'</h3></div><div class="panel-body"><div id="info_'+d+'">\u8d77\u70b9\uff1a'+m+"<br>\u7ec8\u70b9\uff1a"+v+"<br>\u7528\u65f6\uff1a"+g+"<br>\u8def\u7a0b\uff1a"+u+"</div></div></div>";i.append(f)}$("#sum-distance").text(o),$("#sum-duration").text(s)}else alert(t)}function createMarker(e,t,a){lastInfWnd&&lastInfWnd.close();var r=1;if(markers.length>0)for(i=0;i<markers.length;i++)markers[i].position==t&&(r=-1);if(1==r){var n=new google.maps.Marker({map:e,position:t,title:a,draggable:!0,animation:google.maps.Animation.DROP});markers.push(n),e.setCenter(t),google.maps.event.addListener(n,"click",function(){createInfoWindow(currentMap,n),toggleBounce(n)}),google.maps.event.addListener(n,"rightclick",function(){removeMarker(n,null,getCurrentMapID())})}}function saveMarker(e,t,a,r,n){var i=r.position.lat().toFixed(6),o=r.position.lng().toFixed(6),s={marker:{map_id:n,title:t,desc:a,lat:i,lng:o}};$.ajax({type:"POST",url:"/markers",data:s,dataType:"json",success:function(t){var a=t.success;if(a){r.setDraggable(!1);createNormalInfoWnd(e,r,n,t)}else alert(t.content)},error:function(){alert("\u4fdd\u5b58\u5931\u8d25\uff01\u7a0d\u540e\u91cd\u8bd5\uff01")}})}function removeMarker(e,t,a){for(i=0;i<markers.length;i++)markers[i].position==e.position&&markers.splice(i,1);if(null!=t?t.close():lastInfWnd&&lastInfWnd.close(),e.getDraggable())alert("invoke"),e.setMap(null);else{var r=e.position.lat().toFixed(6),n=e.position.lng().toFixed(6),o={del:"true",map_id:a,lat:r,lng:n};$.ajax({type:"DELETE",url:"/markers/destroy",data:o,dataType:"json",success:function(){e.setMap(null),alert("\u5220\u9664\u6210\u529f\uff01")},error:function(){alert("\u5220\u9664\u5931\u8d25\uff01")}})}}function setAllMarkers(e,t){var a={map:{map_id:t}};$.ajax({type:"POST",url:"/maps/find_markers",data:a,dataType:"json",success:function(t){var a=t.success;if(a){for(i=0;i<t.markers.length;i++){var r=new google.maps.LatLng(t.markers[i].lat,t.markers[i].lng),n=t.markers[i].title;createMarker(e,r,n)}for(i=0;i<markers.length;i++)markers[i].setDraggable(!1);0!=markers.length&&e.setCenter(markers[0].position)}else alert(t.content)},error:function(){alert("\u4fdd\u5b58\u5931\u8d25\uff01\u7a0d\u540e\u91cd\u8bd5\uff01")}})}function createInfoWindow(e,t){var a=t.position.lat().toFixed(6),r=t.position.lng().toFixed(6),n=getCurrentMapID(),i={marker:{map_id:n,lat:a,lng:r}};$.ajax({type:"POST",url:"/maps/check_marker",data:i,dataType:"json",success:function(a){if(a.success){t.setDraggable(!1);var r=a;createNormalInfoWnd(e,t,n,r)}else createFormInfoWnd(e,t,n)},error:function(e,t,a){alert("\u5d29\u6e83\u4e86!!!"),alert(a)}})}function createNormalInfoWnd(e,t,a,r){lastInfWnd&&lastInfWnd.close();var n=new google.maps.InfoWindow,i=$('<div ><h6 class="page-header" style="margin: 0px">\u6211\u7684\u6807\u7b7e</h4><table class="table-responsive"><tr><td>\u6807\u9898:</td>       <td>'+r.marker.title+"</td> </tr><tr><td>\u63cf\u8ff0\u5185\u5bb9:</td>   <td> "+r.marker.desc+'</td> </tr><tr><td></td><td><input class="btn btn-danger remove-marker" type="button" value="\u5220\u9664\u6807\u7b7e"/></td></tr></table></div>');n.setContent(i[0]),n.open(e,t),lastInfWnd=n;var o=i.find("input.remove-marker")[0];google.maps.event.addDomListener(o,"click",function(){removeMarker(t,n,getCurrentMapID())})}function createFormInfoWnd(e,t,a){lastInfWnd&&lastInfWnd.close();var r=(t.position.lat().toFixed(6)+","+t.position.lng().toFixed(6),$('<div ><h6 class="page-header" style="margin: 0px">\u6dfb\u52a0\u6807\u8bb0</h4><table class="table-responsive"><tr><td>\u6807\u9898:</td>       <td><input class="title" type="text" id="title" placeholder="\u6807\u9898"/> </td> </tr><tr><td>\u63cf\u8ff0\u5185\u5bb9:</td>   <td><textarea class="desc" rows="3" id="desc" placeholder="\u5185\u5bb9"/></td> </tr><tr><td></td>           <td><input class="btn btn-primary save-marker" type="button" value="\u6807\u8bb0"/><input class="btn btn-danger remove-marker" type="button" value="\u5220\u9664\u6807\u7b7e"/></td></tr></table></div>')),n=new google.maps.InfoWindow;n.setContent(r[0]),n.open(e,t),lastInfWnd=n;var i=r.find("input.save-marker")[0],o=r.find("input.remove-marker")[0];"undefined"!=typeof i&&google.maps.event.addDomListener(i,"click",function(){var n=r.find("input.title")[0].value,i=r.find("textarea.desc")[0].value;saveMarker(e,n,i,t,a)}),google.maps.event.addDomListener(o,"click",function(){removeMarker(t,n,getCurrentMapID())})}function validate(){alert(document.getElementById("username").value),alert(document.getElementById("password").value),alert(document.getElementById("check").value)}function t(e){google.maps.event.addListener(currentMap,"zoom_changed",function(){var t=map.getZoom();e.setContent("Zoom: "+t)})}function attachMessage(e){var t="This is a secret message!",a=new google.maps.InfoWindow({content:t,size:new google.maps.Size(50,50)});google.maps.event.addListener(e,"click",function(){a.open(currentMap,e)})}var centerLatitude=31.4829,centerLangitude=120.2776,centerLatLng,startZoom=13,map,DefaultZoom=15,markers,lastInfWnd,currentMap,geocoder,recvResults,mapDiv,lenArray=[],origin,directionsDisplay,directionsService,polyline,polylinesArray=[];